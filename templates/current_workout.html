{% extends "base.html" %}
{% block title %}Current Workout - BuiltBuff{% endblock %}
{% block content %}

<main class="main-content">
    <h1 class="heading-primary">{{ workout_session.session_name }}</h1>
    <form id="add-workout-form" method="POST">
        <div class="form-group">
            <label for="exercise_search">Exercise Name:</label>
            <input type="text" id="exercise_search" name="exercise_name" class="form-control" autocomplete="off" required>
            <div id="exercise_suggestions" class="suggestions"></div>
        </div>
        <div class="form-group">
            <label for="equipment_select">Equipment:</label>
            <select id="equipment_select" name="equipment" class="form-control" required>
                <option value="">Select Equipment</option>
            </select>
        </div>
        <div class="form-group">
            <label for="weight">Weight (lbs):</label>
            <input type="number" name="weight" id="weight" class="form-control" required>
        </div>
        <div class="form-group">
            <label for="reps">Reps:</label>
            <input type="number" name="reps" id="reps" class="form-control" required>
        </div>
        <button type="submit" class="btn btn-primary">Add Workout</button>
    </form>
    <button id="end-session-btn" class="btn btn-danger">End Session</button>

    <h2>Your Workouts</h2>
    <table>
        <thead>
            <tr>
                <th>Exercise</th>
                <th>Equipment</th>
                <th>Weight</th>
                <th>Reps</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for workout in workouts %}
            <tr>
                <td>{{ workout.exercise_name }}</td>
                <td>{{ workout.equipment }}</td>
                <td>{{ workout.weight }} lbs</td>
                <td>{{ workout.reps }}</td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="showEditForm({{ workout.workout_id }}, '{{ workout.exercise_name }}', '{{ workout.equipment }}', {{ workout.weight }}, {{ workout.reps }})">Edit</button>
                    <form action="{{ url_for('delete_workout_log', log_id=workout.workout_id) }}" method="POST" style="display:inline;">
                        <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Hidden form to edit workout -->
    <div id="edit-workout-form" style="display:none;">
        <form method="POST" action="" id="edit-form">
            <div class="form-group">
                <label for="edit_exercise_search">Exercise Name:</label>
                <input type="text" id="edit_exercise_search" name="exercise_name" class="form-control" autocomplete="off" required>
                <div id="edit_exercise_suggestions" class="suggestions"></div>
            </div>
            <div class="form-group">
                <label for="edit_equipment_select">Equipment:</label>
                <select id="edit_equipment_select" name="equipment" class="form-control" required>
                    <!-- Options will be populated dynamically -->
                </select>
            </div>
            <div class="form-group">
                <label for="edit_weight">Weight:</label>
                <input type="number" name="weight" id="edit_weight" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="edit_reps">Reps:</label>
                <input type="number" name="reps" id="edit_reps" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-primary">Update Workout</button>
            <button type="button" onclick="hideEditForm()" class="btn btn-secondary">Cancel</button>
        </form>
    </div>
</main>

<script>
// JavaScript for exercise autocomplete and equipment selection

let exerciseInput = document.getElementById('exercise_search');
let suggestionsDiv = document.getElementById('exercise_suggestions');
let equipmentSelect = document.getElementById('equipment_select');

exerciseInput.addEventListener('input', function() {
    let term = exerciseInput.value;
    if (term.length > 1) {
        fetch('/search_exercise_names?search_term=' + encodeURIComponent(term))
            .then(response => response.json())
            .then(data => {
                suggestionsDiv.innerHTML = '';
                // Ensure unique exercise names
                let uniqueExercises = [];
                data.results.forEach(function(item) {
                    if (!uniqueExercises.includes(item.exercise_name)) {
                        uniqueExercises.push(item.exercise_name);
                        let suggestion = document.createElement('div');
                        suggestion.classList.add('suggestion-item');
                        suggestion.textContent = item.exercise_name;
                        suggestion.addEventListener('click', function() {
                            exerciseInput.value = item.exercise_name;
                            suggestionsDiv.innerHTML = '';
                            loadEquipmentOptions(item.exercise_name);
                        });
                        suggestionsDiv.appendChild(suggestion);
                    }
                });
            });
    } else {
        suggestionsDiv.innerHTML = '';
    }
});

function loadEquipmentOptions(exerciseName) {
    fetch('/get_equipment_options?exercise_name=' + encodeURIComponent(exerciseName))
        .then(response => response.json())
        .then(data => {
            equipmentSelect.innerHTML = '<option value="">Select Equipment</option>';
            data.forEach(function(equipment) {
                let option = document.createElement('option');
                option.value = equipment;
                option.textContent = equipment;
                equipmentSelect.appendChild(option);
            });
        });
}

// Handle form submission for adding a workout
document.getElementById('add-workout-form').addEventListener('submit', function(e) {
    let exerciseName = exerciseInput.value;
    let equipment = equipmentSelect.value;
    if (!exerciseName || !equipment) {
        e.preventDefault();
        alert('Please select an exercise and equipment.');
    }
});

function hideEditForm() {
    document.getElementById('edit-workout-form').style.display = 'none';
}

document.getElementById('end-session-btn').addEventListener('click', function() {
    fetch('{{ url_for('end_session') }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
    }).then(response => {
        if (response.ok) {
            window.location.href = '{{ url_for('history') }}';
        }
    });
});

// Functions for the edit form
let editExerciseInput = document.getElementById('edit_exercise_search');
let editSuggestionsDiv = document.getElementById('edit_exercise_suggestions');
let editEquipmentSelect = document.getElementById('edit_equipment_select');
let editWeightInput = document.getElementById('edit_weight');
let editRepsInput = document.getElementById('edit_reps');

editExerciseInput.addEventListener('input', function() {
    let term = editExerciseInput.value;
    if (term.length > 1) {
        fetch('/search_exercise_names?search_term=' + encodeURIComponent(term))
            .then(response => response.json())
            .then(data => {
                editSuggestionsDiv.innerHTML = '';
                // Ensure unique exercise names
                let uniqueExercises = [];
                data.results.forEach(function(item) {
                    if (!uniqueExercises.includes(item.exercise_name)) {
                        uniqueExercises.push(item.exercise_name);
                        let suggestion = document.createElement('div');
                        suggestion.classList.add('suggestion-item');
                        suggestion.textContent = item.exercise_name;
                        suggestion.addEventListener('click', function() {
                            editExerciseInput.value = item.exercise_name;
                            editSuggestionsDiv.innerHTML = '';
                            loadEditEquipmentOptions(item.exercise_name);
                        });
                        editSuggestionsDiv.appendChild(suggestion);
                    }
                });
            });
    } else {
        editSuggestionsDiv.innerHTML = '';
    }
});

function loadEditEquipmentOptions(exerciseName, selectedEquipment = '') {
    fetch('/get_equipment_options?exercise_name=' + encodeURIComponent(exerciseName))
        .then(response => response.json())
        .then(data => {
            editEquipmentSelect.innerHTML = '<option value="">Select Equipment</option>';
            data.forEach(function(equipment) {
                let option = document.createElement('option');
                option.value = equipment;
                option.textContent = equipment;
                if (equipment.toLowerCase() === selectedEquipment.toLowerCase()) {
                    option.selected = true;
                }
                editEquipmentSelect.appendChild(option);
            });
        });
}

function showEditForm(workout_id, exercise_name, equipment, weight, reps) {
    document.getElementById('edit-form').action = '/update_workout_log/' + workout_id;
    editExerciseInput.value = exercise_name;
    editWeightInput.value = weight;
    editRepsInput.value = reps;

    // Load equipment options and set the selected one
    loadEditEquipmentOptions(exercise_name, equipment);

    document.getElementById('edit-workout-form').style.display = 'block';
}
</script>

<style>
/* Additional styles for suggestions */
.suggestions {
    border: 1px solid #ccc;
    max-height: 150px;
    overflow-y: auto;
    position: absolute;
    background-color: #fff;
    z-index: 1000;
    width: calc(100% - 20px);
}

.suggestion-item {
    padding: 5px 10px;
    cursor: pointer;
}

.suggestion-item:hover {
    background-color: #f0f0f0;
}
</style>
{% endblock %}
